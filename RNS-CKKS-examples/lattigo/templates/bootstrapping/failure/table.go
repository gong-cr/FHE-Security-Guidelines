package failure

import (
	"math"
	"math/big"

	"github.com/tuneinsight/lattigo/v5/utils"
	"github.com/tuneinsight/lattigo/v5/utils/bignum"
)

// ModifiedIrwinHall estimates PR[||I(X)|| > K] by evaluating equation (1) of https://eprint.iacr.org/2022/024:
// 1 - (2/(h+1)! * (sum_i=0^{K+0.5(h+1)} (-1)^i * binom(h+1, i) * (K + 0.5(h+1) - i)^{h+1}))-1)^{2n}
// This method produces accurate results, but is O(h^3).
func ModifiedIrwinHall(K, h, logSlots int) (logfailure float64) {

	var prec uint = utils.Max(uint(2*h), 512)

	sum := new(big.Float).SetPrec(prec)

	two := new(big.Float).SetPrec(prec).SetInt64(2)
	one := new(big.Float).SetPrec(prec).SetInt64(1)
	binom := new(big.Float).Set(one)

	for i := 0; i < K+(h+1)>>1; i++ {

		// binom(h+1, i)
		if i > 0 {
			binom.Mul(binom, new(big.Float).SetPrec(prec).SetInt64(int64(h+2-i)))
			binom.Quo(binom, new(big.Float).SetPrec(prec).SetInt64(int64(i)))
		}

		// 2 * (K + 0.5(h+1) - i)^(h+1) / (h+1)!
		x := new(big.Float).SetPrec(prec).SetFloat64(float64(K) + 0.5*float64(h+1) - float64(i))
		y := new(big.Float).Set(one)
		for j := 0; j < h+1; j++ {
			y.Mul(y, x)
			y.Quo(y, new(big.Float).SetPrec(prec).SetInt64(int64(j+1)))
		}

		// binom(h+1, i) * 2 * (K + 0.5(h+1) - i)^(h+1) / (h+1)!
		y.Mul(y, binom)

		if i&1 == 0 {
			sum.Add(sum, y)
		} else {
			sum.Sub(sum, y)
		}
	}

	sum.Mul(sum, two)
	sum.Sub(sum, one)
	sum.Sub(one, sum)

	if sum.Cmp(new(big.Float)) == -1 {
		return math.Inf(-1)
	}

	sum = bignum.Log(sum)
	sum.Quo(sum, bignum.Log2(prec))
	sumF64, _ := sum.Float64()
	return sumF64 + 1 + float64(logSlots)
}

var F8192 = map[int]float64{
	1:   -0.044729,
	2:   -0.090820,
	3:   -0.138291,
	4:   -0.187158,
	5:   -0.237438,
	6:   -0.289147,
	7:   -0.342300,
	8:   -0.396914,
	9:   -0.453002,
	10:  -0.510580,
	11:  -0.569662,
	12:  -0.630261,
	13:  -0.692393,
	14:  -0.756069,
	15:  -0.821303,
	16:  -0.888107,
	17:  -0.956495,
	18:  -1.026477,
	19:  -1.098067,
	20:  -1.171275,
	21:  -1.246112,
	22:  -1.322590,
	23:  -1.400719,
	24:  -1.480510,
	25:  -1.561972,
	26:  -1.645117,
	27:  -1.729952,
	28:  -1.816488,
	29:  -1.904733,
	30:  -1.994698,
	31:  -2.086389,
	32:  -2.179817,
	33:  -2.274988,
	34:  -2.371912,
	35:  -2.470595,
	36:  -2.571046,
	37:  -2.673272,
	38:  -2.777280,
	39:  -2.883077,
	40:  -2.990670,
	41:  -3.100065,
	42:  -3.211270,
	43:  -3.324291,
	44:  -3.439134,
	45:  -3.555804,
	46:  -3.674308,
	47:  -3.794651,
	48:  -3.916840,
	49:  -4.040878,
	50:  -4.166773,
	51:  -4.294529,
	52:  -4.424150,
	53:  -4.555643,
	54:  -4.689011,
	55:  -4.824259,
	56:  -4.961393,
	57:  -5.100415,
	58:  -5.241332,
	59:  -5.384146,
	60:  -5.528863,
	61:  -5.675486,
	62:  -5.824018,
	63:  -5.974465,
	64:  -6.126829,
	65:  -6.281114,
	66:  -6.437325,
	67:  -6.595463,
	68:  -6.755533,
	69:  -6.917539,
	70:  -7.081482,
	71:  -7.247367,
	72:  -7.415197,
	73:  -7.584974,
	74:  -7.756702,
	75:  -7.930383,
	76:  -8.106020,
	77:  -8.283616,
	78:  -8.463174,
	79:  -8.644697,
	80:  -8.828186,
	81:  -9.013644,
	82:  -9.201075,
	83:  -9.390479,
	84:  -9.581860,
	85:  -9.775221,
	86:  -9.970562,
	87:  -10.167887,
	88:  -10.367197,
	89:  -10.568495,
	90:  -10.771783,
	91:  -10.977062,
	92:  -11.184335,
	93:  -11.393604,
	94:  -11.604870,
	95:  -11.818136,
	96:  -12.033403,
	97:  -12.250673,
	98:  -12.469948,
	99:  -12.691229,
	100: -12.914518,
	101: -13.139818,
	102: -13.367128,
	103: -13.596452,
	104: -13.827790,
	105: -14.061145,
	106: -14.296517,
	107: -14.533908,
	108: -14.773319,
	109: -15.014753,
	110: -15.258209,
	111: -15.503691,
	112: -15.751198,
	113: -16.000733,
	114: -16.252296,
	115: -16.505889,
	116: -16.761512,
	117: -17.019169,
	118: -17.278858,
	119: -17.540583,
	120: -17.804343,
	121: -18.070140,
	122: -18.337975,
	123: -18.607849,
	124: -18.879763,
	125: -19.153718,
	126: -19.429716,
	127: -19.707757,
	128: -19.987842,
	129: -20.269973,
	130: -20.554150,
	131: -20.840373,
	132: -21.128646,
	133: -21.418967,
	134: -21.711338,
	135: -22.005760,
	136: -22.302233,
	137: -22.600760,
	138: -22.901339,
	139: -23.203973,
	140: -23.508663,
	141: -23.815408,
	142: -24.124209,
	143: -24.435068,
	144: -24.747986,
	145: -25.062963,
	146: -25.379999,
	147: -25.699096,
	148: -26.020254,
	149: -26.343474,
	150: -26.668757,
	151: -26.996103,
	152: -27.325514,
	153: -27.656989,
	154: -27.990530,
	155: -28.326136,
	156: -28.663810,
	157: -29.003551,
	158: -29.345360,
	159: -29.689238,
	160: -30.035185,
	161: -30.383201,
	162: -30.733289,
	163: -31.085447,
	164: -31.439678,
	165: -31.795980,
	166: -32.154355,
	167: -32.514804,
	168: -32.877327,
	169: -33.241924,
	170: -33.608596,
	171: -33.977344,
	172: -34.348168,
	173: -34.721069,
	174: -35.096047,
	175: -35.473103,
	176: -35.852236,
	177: -36.233449,
	178: -36.616741,
	179: -37.002112,
	180: -37.389564,
	181: -37.779096,
	182: -38.170709,
	183: -38.564404,
	184: -38.960182,
	185: -39.358041,
	186: -39.757984,
	187: -40.160010,
	188: -40.564120,
	189: -40.970314,
	190: -41.378593,
	191: -41.788957,
	192: -42.201407,
	193: -42.615943,
	194: -43.032566,
	195: -43.451275,
	196: -43.872071,
	197: -44.294956,
	198: -44.719928,
	199: -45.146989,
	200: -45.576138,
	201: -46.007378,
	202: -46.440706,
	203: -46.876125,
	204: -47.313634,
	205: -47.753234,
	206: -48.194926,
	207: -48.638708,
	208: -49.084583,
	209: -49.532550,
	210: -49.982610,
	211: -50.434763,
	212: -50.889009,
	213: -51.345349,
	214: -51.803783,
	215: -52.264311,
	216: -52.726935,
	217: -53.191653,
	218: -53.658467,
	219: -54.127377,
	220: -54.598383,
	221: -55.071485,
	222: -55.546684,
	223: -56.023980,
	224: -56.503374,
	225: -56.984866,
	226: -57.468456,
	227: -57.954144,
	228: -58.441931,
	229: -58.931817,
	230: -59.423802,
	231: -59.917887,
	232: -60.414072,
	233: -60.912358,
	234: -61.412744,
	235: -61.915231,
	236: -62.419819,
	237: -62.926509,
	238: -63.435300,
	239: -63.946194,
	240: -64.459190,
	241: -64.974289,
	242: -65.491491,
	243: -66.010796,
	244: -66.532204,
	245: -67.055717,
	246: -67.581334,
	247: -68.109055,
	248: -68.638881,
	249: -69.170812,
	250: -69.704848,
	251: -70.240990,
	252: -70.779238,
	253: -71.319591,
	254: -71.862051,
	255: -72.406618,
	256: -72.953292,
	257: -73.502073,
	258: -74.052961,
	259: -74.605958,
	260: -75.161062,
	261: -75.718274,
	262: -76.277595,
	263: -76.839025,
	264: -77.402564,
	265: -77.968213,
	266: -78.535970,
	267: -79.105838,
	268: -79.677816,
	269: -80.251904,
	270: -80.828103,
	271: -81.406413,
	272: -81.986834,
	273: -82.569366,
	274: -83.154010,
	275: -83.740766,
	276: -84.329634,
	277: -84.920615,
	278: -85.513708,
	279: -86.108914,
	280: -86.706233,
	281: -87.305666,
	282: -87.907212,
	283: -88.510872,
	284: -89.116646,
	285: -89.724535,
	286: -90.334538,
	287: -90.946657,
	288: -91.560890,
	289: -92.177239,
	290: -92.795703,
	291: -93.416283,
	292: -94.038980,
	293: -94.663792,
	294: -95.290721,
	295: -95.919767,
	296: -96.550930,
	297: -97.184211,
	298: -97.819609,
	299: -98.457124,
	300: -99.096758,
	301: -99.738510,
	302: -100.382380,
	303: -101.028369,
	304: -101.676477,
	305: -102.326705,
	306: -102.979051,
	307: -103.633518,
	308: -104.290104,
	309: -104.948810,
	310: -105.609637,
	311: -106.272584,
	312: -106.937652,
	313: -107.604841,
	314: -108.274151,
	315: -108.945583,
	316: -109.619137,
	317: -110.294812,
	318: -110.972610,
	319: -111.652530,
	320: -112.334573,
	321: -113.018739,
	322: -113.705028,
	323: -114.393440,
	324: -115.083976,
	325: -115.776636,
	326: -116.471419,
	327: -117.168327,
	328: -117.867360,
	329: -118.568517,
	330: -119.271799,
	331: -119.977206,
	332: -120.684739,
	333: -121.394397,
	334: -122.106181,
	335: -122.820092,
	336: -123.536128,
	337: -124.254291,
	338: -124.974581,
	339: -125.696998,
	340: -126.421542,
	341: -127.148213,
	342: -127.877012,
	343: -128.607939,
	344: -129.340995,
	345: -130.076178,
	346: -130.813490,
	347: -131.552931,
	348: -132.294501,
	349: -133.038200,
	350: -133.784029,
	351: -134.531987,
	352: -135.282075,
	353: -136.034294,
	354: -136.788642,
	355: -137.545122,
	356: -138.303732,
	357: -139.064473,
	358: -139.827346,
	359: -140.592350,
	360: -141.359485,
	361: -142.128753,
	362: -142.900153,
	363: -143.673685,
	364: -144.449350,
	365: -145.227148,
	366: -146.007079,
	367: -146.789143,
	368: -147.573340,
	369: -148.359672,
	370: -149.148137,
	371: -149.938737,
	372: -150.731471,
	373: -151.526339,
	374: -152.323343,
	375: -153.122482,
	376: -153.923756,
	377: -154.727165,
	378: -155.532711,
	379: -156.340392,
	380: -157.150210,
	381: -157.962164,
	382: -158.776255,
	383: -159.592482,
	384: -160.410847,
	385: -161.231350,
	386: -162.053989,
	387: -162.878767,
	388: -163.705683,
	389: -164.534737,
	390: -165.365929,
	391: -166.199261,
	392: -167.034731,
	393: -167.872340,
	394: -168.712089,
	395: -169.553978,
	396: -170.398006,
	397: -171.244175,
	398: -172.092484,
	399: -172.942933,
	400: -173.795524,
	401: -174.650255,
	402: -175.507127,
	403: -176.366142,
	404: -177.227297,
	405: -178.090595,
	406: -178.956035,
	407: -179.823617,
	408: -180.693342,
	409: -181.565210,
	410: -182.439221,
	411: -183.315375,
	412: -184.193673,
	413: -185.074115,
	414: -185.956701,
	415: -186.841431,
	416: -187.728305,
	417: -188.617324,
	418: -189.508489,
	419: -190.401798,
	420: -191.297253,
	421: -192.194853,
	422: -193.094600,
	423: -193.996492,
	424: -194.900531,
	425: -195.806717,
	426: -196.715049,
	427: -197.625529,
	428: -198.538155,
	429: -199.452930,
	430: -200.369852,
	431: -201.288922,
	432: -202.210140,
	433: -203.133507,
	434: -204.059023,
	435: -204.986687,
	436: -205.916501,
	437: -206.848464,
	438: -207.782577,
	439: -208.718840,
	440: -209.657253,
	441: -210.597816,
	442: -211.540530,
	443: -212.485395,
	444: -213.432411,
	445: -214.381578,
	446: -215.332897,
	447: -216.286368,
	448: -217.241991,
	449: -218.199766,
	450: -219.159694,
	451: -220.121775,
	452: -221.086008,
	453: -222.052395,
	454: -223.020936,
	455: -223.991630,
	456: -224.964479,
	457: -225.939481,
	458: -226.916638,
	459: -227.895950,
	460: -228.877417,
	461: -229.861039,
	462: -230.846817,
	463: -231.834750,
	464: -232.824839,
	465: -233.817085,
	466: -234.811487,
	467: -235.808045,
	468: -236.806761,
	469: -237.807634,
	470: -238.810665,
	471: -239.815853,
	472: -240.823199,
	473: -241.832703,
	474: -242.844366,
	475: -243.858187,
	476: -244.874168,
	477: -245.892308,
	478: -246.912607,
	479: -247.935066,
	480: -248.959685,
	481: -249.986464,
	482: -251.015403,
	483: -252.046504,
	484: -253.079765,
	485: -254.115188,
	486: -255.152772,
	487: -256.192517,
	488: -257.234425,
	489: -258.278495,
	490: -259.324728,
	491: -260.373123,
	492: -261.423681,
	493: -262.476403,
	494: -263.531288,
	495: -264.588337,
	496: -265.647550,
	497: -266.708928,
	498: -267.772470,
	499: -268.838176,
	500: -269.906048,
	501: -270.976085,
	502: -272.048288,
	503: -273.122657,
	504: -274.199192,
	505: -275.277893,
	506: -276.358761,
	507: -277.441795,
	508: -278.526997,
	509: -279.614367,
	510: -280.703904,
	511: -281.795609,
	512: -282.889482,
	513: -283.985524,
	514: -285.083735,
	515: -286.184114,
	516: -287.286663,
	517: -288.391382,
	518: -289.498270,
	519: -290.607328,
	520: -291.718557,
	521: -292.831956,
	522: -293.947527,
	523: -295.065268,
	524: -296.185181,
	525: -297.307265,
	526: -298.431522,
	527: -299.557951,
	528: -300.686552,
	529: -301.817326,
	530: -302.950273,
	531: -304.085394,
	532: -305.222688,
	533: -306.362156,
	534: -307.503798,
	535: -308.647614,
	536: -309.793606,
	537: -310.941772,
	538: -312.092113,
	539: -313.244630,
	540: -314.399323,
	541: -315.556192,
	542: -316.715237,
	543: -317.876459,
	544: -319.039857,
	545: -320.205433,
	546: -321.373187,
	547: -322.543118,
	548: -323.715227,
	549: -324.889514,
	550: -326.065980,
	551: -327.244625,
	552: -328.425449,
	553: -329.608452,
	554: -330.793635,
	555: -331.980999,
	556: -333.170542,
	557: -334.362266,
	558: -335.556171,
	559: -336.752256,
	560: -337.950524,
	561: -339.150973,
	562: -340.353604,
	563: -341.558417,
	564: -342.765413,
	565: -343.974591,
	566: -345.185953,
	567: -346.399498,
	568: -347.615227,
	569: -348.833140,
	570: -350.053237,
	571: -351.275518,
	572: -352.499985,
	573: -353.726637,
	574: -354.955474,
	575: -356.186497,
	576: -357.419705,
	577: -358.655101,
	578: -359.892682,
	579: -361.132451,
	580: -362.374407,
	581: -363.618550,
	582: -364.864882,
	583: -366.113401,
	584: -367.364108,
	585: -368.617005,
	586: -369.872090,
	587: -371.129364,
	588: -372.388829,
	589: -373.650483,
	590: -374.914327,
	591: -376.180361,
	592: -377.448587,
	593: -378.719003,
	594: -379.991611,
	595: -381.266410,
	596: -382.543402,
	597: -383.822585,
	598: -385.103961,
	599: -386.387531,
	600: -387.673293,
	601: -388.961249,
	602: -390.251398,
	603: -391.543742,
	604: -392.838280,
	605: -394.135012,
	606: -395.433940,
	607: -396.735063,
	608: -398.038382,
	609: -399.343896,
	610: -400.651607,
	611: -401.961515,
	612: -403.273619,
	613: -404.587920,
	614: -405.904419,
	615: -407.223116,
	616: -408.544011,
	617: -409.867104,
	618: -411.192396,
	619: -412.519887,
	620: -413.849577,
	621: -415.181467,
	622: -416.515557,
	623: -417.851847,
	624: -419.190338,
	625: -420.531029,
	626: -421.873922,
	627: -423.219017,
	628: -424.566313,
	629: -425.915812,
	630: -427.267513,
	631: -428.621417,
	632: -429.977524,
	633: -431.335835,
	634: -432.696349,
	635: -434.059068,
	636: -435.423990,
	637: -436.791118,
	638: -438.160451,
	639: -439.531989,
	640: -440.905733,
	641: -442.281683,
	642: -443.659839,
	643: -445.040202,
	644: -446.422772,
	645: -447.807549,
	646: -449.194534,
	647: -450.583727,
	648: -451.975129,
	649: -453.368739,
	650: -454.764558,
	651: -456.162586,
	652: -457.562824,
	653: -458.965272,
	654: -460.369930,
	655: -461.776799,
	656: -463.185879,
	657: -464.597170,
	658: -466.010673,
	659: -467.426388,
	660: -468.844315,
	661: -470.264455,
	662: -471.686807,
	663: -473.111373,
	664: -474.538153,
	665: -475.967147,
	666: -477.398355,
	667: -478.831777,
	668: -480.267415,
	669: -481.705268,
	670: -483.145336,
	671: -484.587621,
	672: -486.032122,
	673: -487.478840,
	674: -488.927774,
	675: -490.378927,
	676: -491.832296,
	677: -493.287884,
	678: -494.745691,
	679: -496.205716,
	680: -497.667960,
	681: -499.132423,
	682: -500.599107,
	683: -502.068010,
	684: -503.539134,
	685: -505.012479,
	686: -506.488045,
	687: -507.965833,
	688: -509.445842,
	689: -510.928074,
	690: -512.412528,
}
